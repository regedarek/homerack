---
# Common role - basic system setup and configuration

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  tags: [hostname]

- name: Update /etc/hosts with hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1       {{ inventory_hostname }}"
    state: present
  tags: [hostname]

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"
  tags: [timezone]

- name: Configure locale
  ansible.builtin.locale_gen:
    name: "{{ locale | default('en_US.UTF-8') }}"
    state: present
  tags: [locale]

- name: Upgrade all packages to latest version
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
    cache_valid_time: 3600
  tags: [upgrade]

- name: Install base system packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - sudo
    state: present
  tags: [packages]

- name: Remove unnecessary packages
  ansible.builtin.apt:
    autoremove: true
    autoclean: true
  tags: [cleanup]

- name: Ensure user exists and is in sudo group
  ansible.builtin.user:
    name: "{{ ansible_user | default('pi') }}"
    groups: sudo
    append: true
    shell: /bin/bash
  tags: [users]

- name: Configure sudoers for passwordless sudo
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ ansible_user | default('pi') }}
    line: "{{ ansible_user | default('pi') }} ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [sudo]

- name: Configure SSH - disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: Restart SSH
  tags: [ssh, security]

- name: Configure SSH - keep alive
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ClientAliveInterval'
    line: 'ClientAliveInterval 60'
    state: present
  notify: Restart SSH
  tags: [ssh]

- name: Enable hardware watchdog
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^#?RuntimeWatchdogSec='
    line: 'RuntimeWatchdogSec=10'
    state: present
  when: enable_watchdog | default(false)
  tags: [watchdog]

- name: Configure swap file
  when: swap_size_mb | default(0) | int > 0
  tags: [swap]
  block:
    - name: Check if swap file exists
      ansible.builtin.stat:
        path: /swapfile
      register: swapfile_stat

    - name: Create swap file
      ansible.builtin.command:
        cmd: fallocate -l {{ swap_size_mb }}M /swapfile
      when: not swapfile_stat.stat.exists
      changed_when: true

    - name: Set swap file permissions
      ansible.builtin.file:
        path: /swapfile
        mode: '0600'

    - name: Format swap file
      ansible.builtin.command:
        cmd: mkswap /swapfile
      when: not swapfile_stat.stat.exists
      changed_when: true

    - name: Enable swap file
      ansible.builtin.command:
        cmd: swapon /swapfile
      when: not swapfile_stat.stat.exists
      changed_when: true

    - name: Add swap to fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '^/swapfile'
        line: '/swapfile none swap sw 0 0'
        state: present

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required
  tags: [reboot]

- name: Reboot if required
  ansible.builtin.reboot:
    reboot_timeout: 300
    msg: "Reboot initiated by Ansible for system updates"
  when:
    - reboot_required.stat.exists
    - reboot_if_required | default(false)
  tags: [reboot]